name: Generate PDF from Markdown

on:
  # Automatic trigger on .md file changes
  push:
    paths:
      - 'doc/**/*.md'
    branches: [main, master]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      generation_scope:
        description: 'Generation scope'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - specific
      specific_files:
        description: 'Specific files (comma-separated, e.g., doc/guide.md)'
        required: false
        type: string

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for git diff
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended
        pip install PyPDF2 reportlab
    
    - name: ðŸ” Detect changed files
      id: detect
      run: |
        # Create generated-pdfs directory
        mkdir -p generated-pdfs
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          SCOPE="${{ github.event.inputs.generation_scope }}"
          SPECIFIC="${{ github.event.inputs.specific_files }}"
          
          if [ "$SCOPE" == "all" ]; then
            # Find all .md files in doc/
            FILES=$(find doc -name "*.md" -type f)
          elif [ "$SCOPE" == "specific" ] && [ -n "$SPECIFIC" ]; then
            # Process specific files
            FILES=$(echo "$SPECIFIC" | tr ',' '\n' | while read f; do echo $f; done)
          fi
        else
          # Push event - get changed .md files
          FILES=$(git diff --name-only HEAD~1 HEAD -- 'doc/**/*.md' 2>/dev/null || echo "")
        fi
        
        # Filter and format
        JSON_FILES="["
        FIRST=true
        for file in $FILES; do
          file=$(echo "$file" | xargs)  # Trim
          if [[ "$file" == doc/*.md ]] && [ -f "$file" ]; then
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON_FILES="$JSON_FILES,"
            fi
            JSON_FILES="$JSON_FILES\"$file\""
          fi
        done
        JSON_FILES="$JSON_FILES]"
        
        echo "files=$JSON_FILES" >> $GITHUB_OUTPUT
        echo "Detected files: $JSON_FILES"
    
    - name: ðŸ–¨ï¸ Generate PDFs
      if: steps.detect.outputs.files != '[]'
      id: generate
      env:
        FILES_JSON: ${{ steps.detect.outputs.files }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        echo "Starting PDF generation..."
        
        # Create watermark text
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        WATERMARK="Generated by $GITHUB_ACTOR on $TIMESTAMP"
        echo "Watermark: $WATERMARK"
        
        # Process files
        python3 scripts/generate_pdfs.py "$FILES_JSON" "$WATERMARK"
        
        # Count generated PDFs
        COUNT=$(find generated-pdfs -name "*.pdf" -type f | wc -l)
        echo "pdf_count=$COUNT" >> $GITHUB_OUTPUT
    
    - name: ðŸ’¾ Commit generated PDFs
      if: steps.generate.outputs.pdf_count != '0'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add generated-pdfs/
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MSG="ðŸ“„ Manual PDF generation"
        else
          MSG="ðŸ¤– Auto-generated PDF from markdown changes"
        fi
        
        git commit -m "$MSG - ${{ steps.generate.outputs.pdf_count }} file(s) [skip ci]" || echo "No changes"
        git push